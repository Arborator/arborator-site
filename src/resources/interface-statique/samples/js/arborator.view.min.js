/*!
 * arborator script for dependency viewing 
 * version 1.0
 * http://arborator.ilpga.fr/
 *
 * Copyright 2010-2012, Kim Gerdes
 *
 * This program is free software:
 * Licensed under version 3 of the GNU Affero General Public License (the "License");
 * you may not use this file except in compliance with the License. 
 * You may obtain a copy of the License at http://www.gnu.org/licenses/agpl-3.0.html
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
 * See the License for the specific language governing permissions and limitations under the License. 
 *
 */

shownfeatures=["t","cat","lemma"];shownsentencefeatures=["markupIU"];functions=["dep","sub","pred","obj","obl","ad","root","para","junc","dep_inherited","sub_inherited","pred_inherited","obj_inherited","obl_inherited","ad_inherited","root_inherited","para_coord","para_hyper","para_intens","para_disfl","para_reform","para_dform","para_negot","attention","--ERASE--","--ERASE--"];funcDic={ad:{stroke:"#000000","stroke-width":"1","stroke-dasharray":""},"--ERASE--":{stroke:"#d00202","stroke-width":"1"},pred_inherited:{stroke:"#999999","stroke-width":"1","stroke-dasharray":". "},para_disfl:{stroke:"#1437AD","stroke-width":"1","stroke-dasharray":""},para_intens:{stroke:"#1437AD","stroke-width":"1","stroke-dasharray":""},sub_inherited:{stroke:"#999999","stroke-width":"1","stroke-dasharray":". "},sub:{stroke:"#000000","stroke-width":"1","stroke-dasharray":""},obl_inherited:{stroke:"#999999","stroke-width":"1","stroke-dasharray":". "},pred:{stroke:"#000000","stroke-width":"1","stroke-dasharray":""},para_negot:{stroke:"#1437AD","stroke-width":"1","stroke-dasharray":""},para_coord:{stroke:"#1437AD","stroke-width":"1","stroke-dasharray":""},dep_inherited:{stroke:"#999999","stroke-width":"1","stroke-dasharray":". "},para:{stroke:"#01949B","stroke-width":"1","stroke-dasharray":""},junc:{stroke:"#00C618","stroke-width":"1","stroke-dasharray":""},attention:{stroke:"#DD137B","stroke-width":"1","stroke-dasharray":"- "},para_dform:{stroke:"#1437AD","stroke-width":"1","stroke-dasharray":""},para_hyper:{stroke:"#1437AD","stroke-width":"1","stroke-dasharray":""},ad_inherited:{stroke:"#999999","stroke-width":"1","stroke-dasharray":". "},root_inherited:{stroke:"#999999","stroke-width":"1","stroke-dasharray":". "},para_reform:{stroke:"#1437AD","stroke-width":"1","stroke-dasharray":""},obl:{stroke:"#000000","stroke-width":"1","stroke-dasharray":""},obj:{stroke:"#000000","stroke-width":"1","stroke-dasharray":""},dep:{stroke:"#000000","stroke-width":"1","stroke-dasharray":""},obj_inherited:{stroke:"#999999","stroke-width":"1","stroke-dasharray":". "},root:{stroke:"#000000","stroke-width":"1","stroke-dasharray":""}};categoryindex="1";root="ROOT";catDic={Adv:{fill:"#69399d"},PP:{fill:"#69399d"},Qu:{fill:"#69399d"},D:{fill:"#69399d"},Cl:{fill:"#69399d"},I:{fill:"#69399d"},Pro:{fill:"#69399d"},J:{fill:"#69399d"},"Pre ":{fill:"#69399d"},N:{fill:"#69399d"},V:{fill:"#69399d"},CS:{fill:"#69399d"},X:{fill:"#69399d"},Adj:{fill:"#69399d"}};tab=8;line=25;dependencyspace=320;xoff=8;linedeps=6;pois=4;tokdepdist=15;funccurvedist=8;depminh=15;worddistancefactor=2;extraspace=50;defaultattris={font:'14px "Arial"',"text-anchor":"start"};attris={t:{font:'18px "Arial"',"text-anchor":"start",fill:"#000","stroke-width":"0"},cat:{font:'12px "Times"',"text-anchor":"start",fill:"#036"},lemma:{font:'14px "Times"',"text-anchor":"start",fill:"#036"},depline:{stroke:"#999","stroke-width":"1","stroke-dasharray":""},deptext:{font:'12px "Times"',"font-style":"italic",fill:"#999"},form:{"font-style":"italic"}};colored={dependency:null};attris[shownfeatures[categoryindex]]=attris.cat;colored[shownfeatures[categoryindex]]=null;

function Pnode(k,e){k=parseInt(k,10);this.index=k;this.gov={};if("gov" in e){for(var g in e.gov){this.gov[parseInt(g,10)]=e.gov[g]}}this.width=0;this.features=new Object();this.svgs=new Object();var m=dependencyspace;for(var g in shownfeatures){var h=shownfeatures[g];this.features[h]=e[h];if((e[h] instanceof Object)){var b=e[h][0][1][0];if(b=="ok"){c=e[h][0][0];var n=paper.text(currentx,m,c);n.attr(defaultattris);n.attr({fill:"#"+compacolors[b],title:"All annotators agree."})}else{c="";ti="";for(g in e[h]){c=c+" "+e[h][g][0];ti=ti+" "+e[h][g][0]+" ("+e[h][g][1]+")"}var n=paper.text(currentx,m,c);n.attr(defaultattris);n.attr({fill:"red",title:ti})}}else{var n=paper.text(currentx,m,e[h]);n.attr(defaultattris);if(h in e){n.attr(attris[h])}}n.attr("index",k);var d=n.getBBox().width;n.width=d;n.index=k;n.node.setAttribute("class",h);if(h in colored&&e[h] in catDic){n.attr(catDic[e[h]])}this.svgs[h]=n;if(d>this.width){this.width=d}m=m+line}for(var l in e){v=e[l];if(l in this.features||l=="gov"){continue}this.features[l]=v}svgwi=svgwi+this.width+tab;this.x=0;this.y=0;this.svgdep={}}drawsvgDep=function(k,b,w,e,u,d,h,g,r,m){var o=currentsvg.paper.set();var s=Math.abs(w-u)/2;var p=Math.max(e-s-worddistancefactor*Math.abs(k-b),-tokdepdist);p=Math.min(p,e-depminh);var l="M"+w+","+e+"C"+w+","+p+" "+u+","+p+" "+u+","+d;var x=currentsvg.paper.path(l).attr(attris.depline).attr({x:w,y:e});var n=currentsvg.paper.pointer(u,d,pois,0).attr(attris.depline);a=x.getPointAtLength(x.getTotalLength()/2);t=currentsvg.paper.text(a.x,a.y-funccurvedist-m*10,h);t.attr(attris.deptext);t.index=k;t.govind=b;if(b==0){var f=a.x+t.getBBox().width/2+funccurvedist/2;if(f+t.getBBox().width/2>svgwi){f=a.x-t.getBBox().width/2-funccurvedist/2}if(f-t.getBBox().width/2<0){f=a.x}t.attr("x",f)}if(r){x.attr({stroke:r});n.attr({stroke:r});t.attr({fill:r,title:g})}else{if("dependency" in colored&&h in funcDic){var q=funcDic[h];x.attr(q);n.attr({stroke:q.stroke});t.attr({fill:q.stroke})}}o.push(t);o.push(x);o.push(n);return o};drawDep=function(g,k,h,l){if(k==0){r=currentsvg.words[g];var d=r.svgs[shownfeatures[0]].attr("x")+r.svgs[shownfeatures[0]].width/2;var n=r.svgs[shownfeatures[0]].attr("y")-tokdepdist;var e=d;var p=0}else{var s=currentsvg.words[k];var r=currentsvg.words[g];if(s==null){delete r.gov[k];return}if(g<k){var e=s.svgs[shownfeatures[0]].attr("x")+s.svgs[shownfeatures[0]].width/2-xoff}else{var e=s.svgs[shownfeatures[0]].attr("x")+s.svgs[shownfeatures[0]].width/2+xoff}var d=r.svgs[shownfeatures[0]].attr("x")+r.svgs[shownfeatures[0]].width/2;var p=s.svgs[shownfeatures[0]].attr("y")+pois-tokdepdist;var n=r.svgs[shownfeatures[0]].attr("y")-tokdepdist-l*linedeps}if((h instanceof Object)){var b=h[0][1][0];if(b=="ok"){h=h[0][0];r.svgdep[k]=drawsvgDep(g,k,e,p,d,n,h,"All annotators agree.","#"+compacolors[b],0)}else{var o=false;for(i in h){var f=h[i];i=parseInt(i,10);for(j in f[1]){var q=f[1][j];j=parseInt(j,10);var m=drawsvgDep(g,k,e+j*2,p,parseInt(d,10)+j*2,n,f[0],f[0]+" ("+q+") ","#"+compacolors[q],i+j);if(o){o.push(m)}else{o=m}r.svgdep[k]=o}}}}else{r.svgdep[k]=drawsvgDep(g,k,e,p,d,n,h,"click to change",false,0)}};drawalldeps=function(){for(var b in currentsvg.words){var e=currentsvg.words[b];for(var b in e.svgdep){e.svgdep[b].remove();delete e.svgdep[b]}e.svgdep={};var d=0;for(var b in e.gov){drawDep(e.index,b,e.gov[b],d);d+=1}}};drawalldeps2=function(){var b=new Object();for(var d in currentsvg.words){var f=currentsvg.words[d];for(var d in f.gov){d=parseInt(d,10);if(d!=0){dis=Math.abs(f.index-d);if(dis in b){b[dis].push([f.index,d])}else{b[dis]=[[f.index,d]]}}}}for(var d in currentsvg.words){var f=currentsvg.words[d];for(var d in f.svgdep){f.svgdep[d].remove();delete f.svgdep[d]}f.svgdep={};var e=0;for(var d in f.gov){drawDep(f.index,d,f.gov[d],e);e+=1}}};makewords=function(e){var f=new Object();svgwi=0;currentx=tab;for(var b in e){var d=new Pnode(b,e[b]);f[b]=d;currentx=currentx+d.width+tab}return f};draw=function(b,d){paper=Raphael(b,window.innerWidth-100,100);currentsvg=paper.canvas;currentsvg.paper=paper;currentsvg.words=makewords(d);currentsvg.setAttribute("width",svgwi+extraspace);currentsvg.setAttribute("height",dependencyspace+shownfeatures.length*line);drawalldeps()};Raphael.fn.pointer=function(d,l,e,k){var b=d+","+(l+e);var f="0,0"+(-e/2)+","+(-e*1.5)+" "+(-e/2)+","+(-e*1.5);var g=(e/2)+","+(e/2)+" "+(e/2)+","+(e/2)+" "+(e)+",0";var h=this.path("M"+b+"c"+f+"c"+g+"z");h.rotate(k);return h};
